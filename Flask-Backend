from flask import Flask, request, jsonify
from web3 import Web3

app = Flask(__name__)

# إعداد الاتصال بـ Ethereum (تأكد من أنك تستخدم عنوان RPC الصحيح)
infura_url = "https://mainnet.infura.io/v3/YOUR_INFURA_PROJECT_ID"
web3 = Web3(Web3.HTTPProvider(infura_url))

# تأكد من أن الاتصال بـ Ethereum ناجح
if not web3.isConnected():
    print("لم نتمكن من الاتصال بشبكة Ethereum.")
    exit()

# عنوان العقد الذكي الخاص بك (تأكد من أنه موجود على شبكة إيثيريوم)
contract_address = "0xYourSmartContractAddress"
abi = [ ... ]  # ABI الخاص بالعقد الذكي

# الاتصال بالعقد الذكي
contract = web3.eth.contract(address=contract_address, abi=abi)

@app.route('/submitPoll', methods=['POST'])
def submit_poll():
    try:
        # استخراج البيانات من الطلب
        data = request.get_json()
        question = data['question']
        options = data['options']
        
        # إرسال البيانات إلى العقد الذكي
        # هنا يمكنك استدعاء وظيفة في العقد الذكي لإنشاء استطلاع جديد
        tx = contract.functions.createPoll(question, options).buildTransaction({
            'from': "0xYourWalletAddress",  # عنوان المحفظة الخاصة بك
            'gas': 2000000,
            'gasPrice': web3.toWei('20', 'gwei'),
            'nonce': web3.eth.getTransactionCount("0xYourWalletAddress"),
        })

        # توقيع المعاملة باستخدام المحفظة الخاصة بك
        private_key = "your_private_key"  # تأكد من تأمين المفتاح الخاص بشكل جيد
        signed_tx = web3.eth.account.signTransaction(tx, private_key)
        tx_hash = web3.eth.sendRawTransaction(signed_tx.rawTransaction)

        return jsonify({"status": "success", "tx_hash": tx_hash.hex()})
    except Exception as e:
        return jsonify({"status": "error", "message": str(e)})

if __name__ == '__main__':
    app.run(debug=True)
